{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 88, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sehaj/dyad-apps/the-open-shelf/src/app/api/sync/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport Parser from 'rss-parser';\n\nconst parser = new Parser({\n  customFields: {\n    item: [\n      ['content:encoded', 'contentEncoded'], \n      ['description', 'description'],\n      ['media:content', 'mediaContent'],\n      ['enclosure', 'enclosure'],\n      ['media:thumbnail', 'mediaThumbnail']\n    ],\n  }\n});\n\nconst extractImageUrl = (item: any): string | null => {\n  if (item.mediaContent && item.mediaContent.$ && item.mediaContent.$.url) return item.mediaContent.$.url;\n  if (item.enclosure && item.enclosure.url && (item.enclosure.type?.startsWith('image/') || item.enclosure.url.match(/\\.(jpg|jpeg|png|webp|gif|svg)/i))) return item.enclosure.url;\n  if (item.mediaThumbnail && item.mediaThumbnail.$ && item.mediaThumbnail.$.url) return item.mediaThumbnail.$.url;\n  \n  const content = item.contentEncoded || item.content || item.description || '';\n  const imgRegex = /<img[^>]+(?:src|data-src|data-full-url|data-original-src)=\"([^\">]+)\"/i;\n  const match = content.match(imgRegex);\n  return match && match[1] ? match[1] : null;\n};\n\nexport async function POST(req: Request) {\n  try {\n    const { feedUrl } = await req.json();\n    const authHeader = req.headers.get('Authorization');\n    \n    if (!authHeader) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n\n    const supabase = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    );\n    \n    const { data: { user } } = await supabase.auth.getUser(authHeader.replace('Bearer ', ''));\n    if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n\n    const response = await fetch(feedUrl);\n    const xml = await response.text();\n    const feed = await parser.parseString(xml);\n    \n    const { data: feedData, error: feedError } = await supabase\n      .from('feeds')\n      .upsert({ \n        url: feedUrl, \n        title: feed.title || 'Untitled', \n        user_id: user.id \n      }, { onConflict: 'url,user_id' })\n      .select('id')\n      .single();\n\n    if (feedError) throw feedError;\n\n    const articles = feed.items.map((item) => {\n      const content = item.contentEncoded || item.content || item.description || '';\n      const wordCount = content.split(/\\s+/).length;\n      return {\n        feed_id: feedData.id,\n        user_id: user.id,\n        title: item.title || 'Untitled',\n        author: item.creator || item.author || feed.title || 'Unknown',\n        source: feed.title || 'Source',\n        url: item.link,\n        content,\n        excerpt: (item.contentSnippet || item.description || '').substring(0, 300).replace(/<[^>]*>?/gm, '') + '...',\n        published_at: item.isoDate || new Date().toISOString(),\n        reading_time: `${Math.ceil(wordCount / 225)} min read`,\n        image_url: extractImageUrl(item),\n        x: Math.floor(Math.random() * 4000) - 2000,\n        y: Math.floor(Math.random() * 4000) - 2000\n      };\n    }).slice(0, 40);\n\n    if (articles.length > 0) {\n      const { error: insertError } = await supabase.from('articles').upsert(articles, { onConflict: 'url,user_id' });\n      if (insertError) throw insertError;\n    }\n\n    return NextResponse.json({ success: true, count: articles.length });\n  } catch (error: any) {\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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"}}]
}